<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>IT 运维支持系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  background: #f4f7fb;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
}
.container {
  max-width: 900px;
  margin: 40px auto;
  background: #fff;
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
}
h1 {
  margin: 0;
}
.sub {
  color: #666;
  margin-bottom: 20px;
}
.row {
  display: flex;
  gap: 20px;
}
.form-group {
  margin-bottom: 16px;
  flex: 1;
}
label {
  font-weight: 600;
  display: block;
  margin-bottom: 6px;
}
input, select, textarea {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #dcdcdc;
}
textarea {
  resize: vertical;
}
.actions {
  margin-top: 20px;
}
button {
  padding: 12px 28px;
  border-radius: 20px;
  border: none;
  cursor: pointer;
}
.btn-primary {
  background: #3f6cf4;
  color: #fff;
}
.btn-secondary {
  background: #eee;
}
.alert {
  background: #fff4f4;
  color: #b40000;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 20px;
}
footer {
  text-align: center;
  color: #999;
  margin-top: 30px;
}
</style>
</head>

<body>

<div class="container">
  <h1>IT 运维支持系统</h1>
  <div class="sub">内部报修入口 · 提交后自动生成工单</div>

  <div id="alert" class="alert" style="display:none"></div>

  <form id="repairForm">

    <div class="row">
      <div class="form-group">
        <label>报修部门 *</label>
        <script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxo8959wtz4dU-WsA2x2vr8WTwTbp77ryM_cqXdihT263PP3qpREjcaROOtbH7wbMOHbQ/exec';

document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('department');

  fetch(API_URL + '?action=getDepartments')
    .then(res => res.json())
    .then(json => {
      if (!json.ok || !Array.isArray(json.data)) {
        throw new Error('API 返回异常');
      }

      // 清空“加载中…”
      select.innerHTML = '<option value="">请选择科室</option>';

      json.data.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    })
    .catch(err => {
      console.error(err);
      select.innerHTML = '<option value="">无法加载科室</option>';
      alert('无法加载部门列表，请联系 IT');
    });
});
</script>

        <select id="department" required>
          <option value="">加载中…</option>
        </select>
      </div>

      <div class="form-group">
        <label>问题类型 *</label>
        <select id="type" required>
          <option value="">请选择</option>
          <option>系统</option>
          <option>网络</option>
          <option>硬件</option>
          <option>账号权限</option>
          <option>其他</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>问题标题 *</label>
      <input id="title" required placeholder="简要描述问题" />
    </div>

    <div class="form-group">
      <label>问题描述 *</label>
      <textarea id="description" rows="4" required placeholder="请详细描述问题现象"></textarea>
    </div>

    <div class="row">
      <div class="form-group">
        <label>联系方式 *</label>
        <input id="contact" required placeholder="姓名 / 电话 / 微信" />
      </div>

      <div class="form-group">
        <label>具体位置 *</label>
        <input id="location" required placeholder="如：3楼护士站" />
      </div>
    </div>

    <div class="form-group">
      <label>备注</label>
      <input id="remark" placeholder="如：下午两点后方便" />
    </div>

    <div class="actions">
      <button id="submitBtn" class="btn-primary" type="submit">提交工单</button>
      <button type="reset" class="btn-secondary">清空重填</button>
    </div>
  </form>

  <footer>© IT 运维系统 · 内部使用</footer>
</div>

<script>
const alertBox = document.getElementById("alert");
const submitBtn = document.getElementById("submitBtn");

function showAlert(msg) {
  alertBox.innerText = msg;
  alertBox.style.display = "block";
}

async function loadDepartments() {
  try {
    const res = await fetch(API_URL + "?action=departments");
    const data = await res.json();
    const sel = document.getElementById("department");
    sel.innerHTML = '<option value="">请选择部门</option>';
    data.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      sel.appendChild(opt);
    });
  } catch {
    showAlert("无法加载部门列表，请联系 IT");
  }
}

document.getElementById("repairForm").addEventListener("submit", async e => {
  e.preventDefault();

  const location = document.getElementById("location").value.trim();
  if (location.length < 4 || location.length > 20) {
    showAlert("具体位置需 4–20 个字");
    return;
  }

  submitBtn.disabled = true;
  submitBtn.innerText = "提交中…";

  const payload = {
    department: department.value,
    type: type.value,
    title: title.value,
    description: description.value,
    contact: contact.value,
    location,
    remark: remark.value
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const r = await res.json();
    if (r.ok) {
      alert("提交成功 ✅ 工单已生成");
      e.target.reset();
    } else {
      throw new Error();
    }
  } catch {
    showAlert("提交失败（网络或权限问题）");
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = "提交工单";
  }
});

loadDepartments();
</script>

</body>
</html>
